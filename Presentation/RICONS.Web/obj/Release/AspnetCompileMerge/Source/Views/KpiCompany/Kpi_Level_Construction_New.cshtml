@model RICONS.Web.Models.thongtinnhanvienModels
@{
    ViewBag.Title = "Thêm mới KPI cấp Công trường";
}
@*--css--*@
@section CSS
{
    <link rel="stylesheet" type="text/css" href="@Url.Content("~")themes/RICONS-2015/css/controller/KpiConstruction/KpiConstruction_New.css" />
    <link rel="stylesheet" type="text/css" href="@Url.Content("~")themes/RICONS-2015/css/chosen/chosen.css" />
    <link rel="stylesheet" type="text/css" href="@Url.Content("~")themes/RICONS-2015/css/chosen/prism.css" />
}

@*--javascript--*@
@section JavaScript
{
    <script type="text/javascript" src="@Url.Content("~")themes/RICONS-2015/js/controllers/KpiConstruction/KpiConstruction_New.js"></script>
    <script type="text/javascript" src="@Url.Content("~")themes/RICONS-2015/js/jquery-ui-1.10.0.custom.min.js"></script>
    <script type="text/javascript" src="@Url.Content("~")themes/RICONS-2015/js/jquery.datepick-vi.js"></script>
    <script type="text/javascript" src="@Url.Content("~")themes/RICONS-2015/js/chosen/chosen.jquery.js"></script>
    <script type="text/javascript" src="@Url.Content("~")themes/RICONS-2015/js/chosen/prism.js"></script>
    <script type="text/javascript" src="@Url.Content("~")themes/RICONS-2015/js/table/buildTable.js"></script>
    <script type="text/javascript" src="@Url.Content("~")themes/RICONS-2015/js/colResizale/colResizable-1.3.source.js"></script>
    <script type="text/javascript" src="@Url.Content("~")Themes/RICONS-2015/css/TableBuild/global/plugins/jquery.blockui.min.js"></script>
    <script type="text/javascript" src="@Url.Content("~")Themes/RICONS-2015/css/TableBuild/global/scripts/app.min.js"></script>

    <script type="text/javascript" src="@Url.Content("~")themes/RICONS-2015/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="@Url.Content("~")themes/RICONS-2015/js/bootbox.min.js"></script>
    <script type="text/javascript" src="@Url.Content("~")themes/RICONS-2015/js/custom.js"></script>

    @*<script src="~/Scripts/jquery-2.1.0.intellisense.js"></script>
        <script src="~/Scripts/jquery-2.1.0.js"></script>
        <script src="~/Scripts/jquery-2.1.0.min.js"></script>*@

}
<script>
    var linkContent = '@Url.Content("~")';
</script>


<div class="HeaderFixed">
    <div class="b-b b-light">
        <div class="p-left c-black">Thêm mới Kpi Cấp Công Trường</div>
        @*<div class="p-left c-black">
                <button id="btn-save" type="button" class="buttoncustom WhiteButton" name="luu" value="Lưu"><i class="retweet_save"></i> Lưu</button>
                <a href="@Url.Action("Index", "Classlist")" class="buttoncustom WhiteButton"><i class="retweet_trove"></i> Trở về</a>
            </div>*@
        <div class="clearBoth"></div>
    </div>
</div>


@*<div class="boxEdit">
        <div class="row">
            <div class="col-md-1" style="min-width: 130px; padding-left:10px;">Tên dự án<label style="color:red;height:10px;">*</label>:</div>
            <div class="col-md-3" style="padding-left:10px;"><input type="text" style="width: 100%;" autocomplete="off" placeholder="Tên dự án" id="txttenduan" name="tenduan" /></div>
        </div>
    </div>*@

<div id="boxContent">
    <div style="width:100%; height:100%">
        <div class="portlet-body">
            <div class="table-responsive">
                <table class="table table-bordered table_danhSach" id="tableContent" style="font-size:12px;">
                    <thead id="head-date">
                    </thead>
                    <tbody id="head-date1"></tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<div style="padding-top:5px;"></div>

<div class="boxEdit">

    @*<div class="row">
            <div class="col-md-1" style="min-width: 160px; padding-left: 10px; "></div>
            <select id="filter01" data-placeholder="Người thực hiện" class="chosen-select-nguoithuchien" name="nguoithuchien" multiple="multiple">
                @if (!string.IsNullOrEmpty(ViewBag.nguoiThucHiens))
                {
                    @Html.Raw(ViewBag.nguoiThucHiens);
                }
            </select>
        </div>*@

    <div class="row">
        <div class="col-md-1"><input type="text" class="hidden" style="width: 100%;" autocomplete="off" placeholder="" id="txtmakpiphongban" name="makpiphongban" value="0" /></div>
        <div class="col-md-1"><input type="text" class="hidden" style="width: 100%;" autocomplete="off" placeholder="" id="txtnguoilapkpi_dagui" name="nguoilapkpi_dagui" value="0" /></div>
    </div>

    <div class="row">
        <div class="col-md-1" style="min-width: 150px; padding-left:10px;">Người lập KPI<label style="color:red;height:10px;">*</label>:</div>
        <div class="col-md-3" style="padding-left: 10px;"><input type="text" style="width: 100%;" autocomplete="off" placeholder="Họ tên người lập KPI" id="txtnguoilapkpi" name="nguoilapkpi" value="@Model.hoten" /></div>

        <div class="col-md-1" style="padding-left: 10px; min-width: 115px; ">Email<label style="color:red;height:10px;">*</label>:</div>
        <div class="col-md-2" style="padding-left:10px;"><input type="text" style="width:100%" autocomplete="off" placeholder="Địa chỉ Email" id="txtnguoilapkpi_email" name="nguoilapkpi_email" value="@Model.mailnhanvien" /></div>

        <div class="col-md-1" style="padding-left: 10px; min-width: 115px; ">Ngày lập KPI<label style="color:red;height:10px;">*</label>:</div>
        <div class="col-md-2" style="padding-left:10px;"><input type="text" style="width:100%" autocomplete="off" placeholder="Ngày lập KPI" id="txtnguoilapkpi_ngay" name="nguoilapkpi_ngay" /></div>

    </div>

    <div class="row">
        <div class="col-md-1" style="min-width: 150px; padding-left: 10px; ">GĐ Khối/P.TGĐ PT<label style="color:red;height:10px;">*</label>:</div>
        <div class="col-md-3" style="padding-left:10px; "><input type="text" style="width:100%" autocomplete="off" placeholder="GĐ Khối/ P.TGĐ phụ trách xem xét" id="txtphotongxemxetkpi" name="photongxemxetkpi" value="@Model.captrentructiep" /></div>

        <div class="col-md-1" style="padding-left: 10px; min-width: 115px; ">Email<label style="color:red;height:10px;">*</label>:</div>
        <div class="col-md-2" style="padding-left:10px;"><input type="text" style="width:100%" autocomplete="off" placeholder="Địa chỉ Email" id="txtphotongxemxetkpi_email" name="photongxemxetkpi_email" value="@Model.captrentructiep_email" /></div>

        <div class="col-md-1" style="padding-left: 10px; min-width: 115px; ">Ngày xem xét<label style="color:red;height:10px;">*</label>:</div>
        <div class="col-md-2" style="padding-left:10px;"><input type="text" style="width:100%" autocomplete="off" placeholder="Ngày xem xét" id="txtphotongxemxetkpi_ngay" name="photongxemxetkpi_ngay" /></div>
    </div>

    <div class="row">
        <div class="col-md-1" style="min-width: 150px; padding-left: 10px; ">Tổng giám đốc<label style="color:red;height:10px;">*</label>:</div>
        <div class="col-md-3" style="padding-left:10px;"><input type="text" style="width: 100%;" autocomplete="off" placeholder="Họ tên tổng giám đốc duyệt" id="txttonggiamdocxemxetkpi" name="tonggiamdocxemxetkpi" value="Lê Miên Thụy" /></div>

        <div class="col-md-1" style="padding-left: 10px; min-width: 115px; ">Email<label style="color:red;height:10px;">*</label>:</div>
        <div class="col-md-2" style="padding-left:10px;"><input type="text" style="width:100%" autocomplete="off" placeholder="Địa chỉ Email" id="txttonggiamdocxemxetkpi_email" name="tonggiamdocxemxetkpi_email" value="thuy.lemien@ricons.vn" /></div>

        <div class="col-md-1" style="padding-left: 10px; min-width: 115px">Ngày xét duyệt<label style="color:red;height:10px;">*</label>:</div>
        <div class="col-md-2" style="padding-left:10px;"><input type="text" style="width:100%" autocomplete="off" placeholder="Ngày xét duyệt" id="txttonggiamdocxemxetkpi_ngay" name="tonggiamdocxemxetkpi_ngay" /></div>
    </div>

    <div class="row" style="padding-top:10px; padding-bottom:50px;">
        <div class="col-md-1" style="min-width: 160px; padding-left: 10px;"></div>
        <button id="btn-save" type="button" class="buttoncustom WhiteButton" name="luu" value="Lưu"><i class="retweet_save"></i> Lưu</button>
        <button id="btn-save-guimail" type="button" class="buttoncustom WhiteButton" name="luu" value="Lưu & gửi" style="width:100px"><i class="retweet_save"></i> Lưu & gửi</button>
        <a href="@Url.Action("Index_Department", "KpiCompany")" class="buttoncustom WhiteButton"><i class="retweet_trove"></i> Trở về</a>
    </div>


</div>


<script>

    $(document).ready(function (e) {
        renderDate();
    });

    function htmlspecialchars(str) {
        str = str.replace(/&/g, "");
        str = str.replace(/"/g, "");
        str = str.replace(/'/g, "");
        return str;
    }


   $('#btn-save').on('click', function (e) {
        e.preventDefault();
        if ($('#txtngaybanhanh').val().length != 10) {
            Thongbao("Ngày ban hành nhập không đúng định dạng (01/01/2018)?");
            return false;
        }
        else if ($('#txtnguoilapkpi_dagui').val().trim()=="1") {
            Thongbao("KPI phòng đã gửi chờ duyệt. Bạn vui lòng không chỉnh sữa?");
            return false;
        }
        var thuoccap = "A";
        var data = [];
        var DataJson = "{'data1':";
        DataJson += "{";
        DataJson += "'makpiphongban':'" + $('#txtmakpiphongban').val() + "',";
        DataJson += "'maphongban':'" + $('#filter02').val() + "',";
        DataJson += "'bophansoanthao':'" + $('#txtbophansoanthao').val() + "',";//lấy làm địa chỉ
        DataJson += "'nam':'" + $('#txtnam').val() + "',";
        DataJson += "'ngaybanhanh':'" + $('#txtngaybanhanh').val() + "',";
        DataJson += "'ngaycapnhat':'" + $('#txtngaycapnhat').val() + "',";
        DataJson += "'thoigianthicongtu':'" + $('#txtthoigianthicongtu').val() + "',";
        DataJson += "'thoigianthicongden':'" + $('#txtthoigianthicongden').val() + "',";
        DataJson += "'hotengiamdocduan':'" + $('#txthotengiamdocduan').val() + "',";
        DataJson += "'nguoilapkpi':'" + $('#txtnguoilapkpi').val() + "',";
        DataJson += "'nguoilapkpi_email':'" + $('#txtnguoilapkpi_email').val() + "',";
        DataJson += "'nguoilapkpi_ngay':'" + $('#txtnguoilapkpi_ngay').val() + "',";

        DataJson += "'photongxemxetkpi':'" + $('#txtphotongxemxetkpi').val() + "',";
        DataJson += "'photongxemxetkpi_email':'" + $('#txtphotongxemxetkpi_email').val() + "',";
        DataJson += "'photongxemxetkpi_ngay':'" + $('#txtphotongxemxetkpi_ngay').val() + "',";

        DataJson += "'tonggiamdocxemxetkpi':'" + $('#txttonggiamdocxemxetkpi').val() + "',";
        DataJson += "'tonggiamdocxemxetkpi_email':'" + $('#txttonggiamdocxemxetkpi_email').val() + "',";
        DataJson += "'tonggiamdocxemxetkpi_ngay':'" + $('#txttonggiamdocxemxetkpi_ngay').val() + "',";

        DataJson += "'bankiemsoat_email':''";

        DataJson += "}, 'data2':[";

        $('#boxContent table tbody tr').each(function (index, item) {
            
            debugger;
            var b = $('#boxContent table tbody tr').length-1;

            var makpiphongban_chitiet = encodeURIComponent($(item).attr('makpiphongban_chitiet'));
            var makpiphongban = encodeURIComponent($(item).attr('makpiphongban'));
            var stt = $(item).find('td.col1').text();

            var congty = $(item).attr('congty');
            var sttcon = $(item).attr('sttcon');
            var sttcha = $(item).attr('sttcha');


            var muctieu = ""; var trongso = "0%"; var ketqua = "0%";
            if (stt == "A" || stt == "B" || stt == "C" || stt == "D" || stt == "E" || stt == "F" || stt == "" || stt == null) {
                muctieu = $(item).find('td.col2').text();
                trongso = $(item).find('td.col3 input').val();
                ketqua = $(item).find('td.col12 input').val();
                thuoccap = stt;
            }
            else {
                muctieu = $(item).find('td.col2 textarea').val();
                trongso = $(item).find('td.col3 textarea').val();
                ketqua = $(item).find('td.col12 textarea').val();
            }
            
            if (congty == undefined) congty = "0";
            if (sttcon == undefined) sttcon = "0";
            if (congty == undefined) congty = "0";

            
            muctieu = muctieu.replace(/'/g, "daunhaydon").replace(/"/g, '').replace(/&/g, 'daukytuva');

            var tieuchidanhgia = $(item).find('td.col4 textarea').val(); if (tieuchidanhgia == undefined) tieuchidanhgia = "";
            else tieuchidanhgia = tieuchidanhgia.replace(/'/g, "daunhaydon").replace(/"/g, '').replace(/&/g, 'daukytuva');

            var cachtinh = $(item).find('td.col5 textarea').val(); if (cachtinh == undefined) cachtinh = "";
            else cachtinh = cachtinh.replace(/'/g, "daunhaydon").replace(/"/g, '').replace(/&/g, 'daukytuva');

            var ngayghinhanketqua = $(item).find('td.col6 textarea').val(); if (ngayghinhanketqua == undefined) ngayghinhanketqua = "";
            else ngayghinhanketqua = ngayghinhanketqua.replace(/'/g, "daunhaydon").replace(/"/g, '').replace(/&/g, 'daukytuva');

            var nguonchungminh = $(item).find('td.col7 textarea').val(); if (nguonchungminh == undefined) nguonchungminh = "";
            else nguonchungminh = nguonchungminh.replace(/'/g, "daunhaydon").replace(/"/g, '').replace(/&/g, 'daukytuva');

            var donvitinh = $(item).find('td.col8 textarea').val(); if (donvitinh == undefined) donvitinh = "";
            else donvitinh = donvitinh.replace(/'/g, "daunhaydon").replace(/"/g, '').replace(/&/g, 'daukytuva');

            var kehoach = $(item).find('td.col9 textarea').val(); if (kehoach == undefined) kehoach = "";
            else kehoach = kehoach.replace(/'/g, "daunhaydon").replace(/"/g, '').replace(/&/g, 'daukytuva');

            var thuchien = $(item).find('td.col10 textarea').val(); if (thuchien == undefined) thuchien = "";
            else thuchien = thuchien.replace(/'/g, "daunhaydon").replace(/"/g, '').replace(/&/g, 'daukytuva');

            var tilehoanthanh = $(item).find('td.col11 textarea').val(); if (tilehoanthanh == undefined) tilehoanthanh = "";
            else tilehoanthanh = tilehoanthanh.replace(/'/g, "daunhaydon").replace(/"/g, '').replace(/&/g, 'daukytuva');

            var ghichu = $(item).find('td.col13 textarea').val(); if (ghichu == undefined) ghichu = "";
            else ghichu = ghichu.replace(/'/g, "daunhaydon").replace(/"/g, '').replace(/&/g, 'daukytuva');

            
            DataJson += "{";
            DataJson += "'makpiphongban_chitiet':'" + makpiphongban_chitiet + "',";
            DataJson += "'makpiphongban':'" + makpiphongban + "',";

            DataJson += "'congty':'" + congty + "',";
            DataJson += "'sttcon':'" + sttcon + "',";
            DataJson += "'sttcha':'" + sttcha + "',";

            DataJson += "'stt':'" + stt + "',";
            DataJson += "'muctieu':'" + muctieu+ "',";

            DataJson += "'tieuchidanhgia':'" + tieuchidanhgia + "',";
            DataJson += "'cachtinh':'" + cachtinh + "',";
            DataJson += "'ngayghinhanketqua':'" + ngayghinhanketqua + "',";
            DataJson += "'nguonchungminh':'" + nguonchungminh + "',";
            DataJson += "'donvitinh':'" + donvitinh + "',";
            DataJson += "'kehoach':'" + kehoach + "',";
            DataJson += "'thuchien':'" + thuchien + "',";
            DataJson += "'tilehoanthanh':'" + tilehoanthanh + "',";
            DataJson += "'ghichu':'" + ghichu + "',";
            DataJson += "'ketqua':'" + ketqua + "',";
            DataJson += "'thuoccap':'" + thuoccap + "',";
            DataJson += "'trongso':'" + trongso + "'";
            DataJson += "}";

            var a = index;
            if (a != b)
                DataJson += ",";
        });
        DataJson += "]}";

        $.ajax({
            type: 'POST',
            url: '/KpiCompany/Save_Construction',
            datatype: "JSON",
            data: "DataJson=" + DataJson,
            cache: false,
        })
        .done(function (result) {
            debugger;
            var tb = JSON.stringify(result.success);
            var makpiphongban = JSON.stringify(result.makpiphongban);
            if (tb == "true") {
                var dialogSuccess = bootbox.dialog({
                    message: "<i class='fa fa-check text-success'></i><span class='text-success'>Lưu dữ liệu thành công.</span>",
                    closeButton: false,
                    onEscape: function () {
                    }
                });
                setTimeout(function () {
                    $('#txtmakpiphongban').val(makpiphongban);
                    GetData_loaddulaidulieu(false);
                    dialogSuccess.modal('hide');
                }, 2000);
            } else {
                var dialogSuccess = bootbox.dialog({
                    message: "<i class='fa fa-check text-success'></i><span class='text-success'>Lưu dữ liệu không thành công</span>",
                    closeButton: false,
                    onEscape: function () {
                    }
                });
                setTimeout(function () {
                    $('#txtmakpiphongban').val(0);
                    dialogSuccess.modal('hide');
                }, 2000);
            }
        })
        .fail(function (result) {
            alert("FAILED: " + JSON.stringify(result));
        });
   })

   $('#btn-save-guimail').on('click', function (e) {

       e.preventDefault();
       if ($('#txtngaybanhanh').val().length != 10) {
           Thongbao("Ngày ban hành nhập không đúng định dạng (01/01/2018)?");
           return false;
       }
       else if ($('#txtnguoilapkpi_dagui').val().trim() == "1") {
           Thongbao("KPI phòng đã gửi chờ duyệt. Bạn vui lòng không chỉnh sữa?");
           return false;
       }
       debugger;
       var thuoccap = "A";
       var data = [];
       var DataJson = "{'data1':";
       DataJson += "{";
       DataJson += "'makpiphongban':'" + $('#txtmakpiphongban').val() + "',";
       DataJson += "'maphongban':'" + $('#filter02').val() + "',";
       DataJson += "'bophansoanthao':'" + $('#txtbophansoanthao').val() + "',";//lấy làm địa chỉ
       DataJson += "'nam':'" + $('#txtnam').val() + "',";
       DataJson += "'ngaybanhanh':'" + $('#txtngaybanhanh').val() + "',";
       DataJson += "'ngaycapnhat':'" + $('#txtngaycapnhat').val() + "',";
       DataJson += "'thoigianthicongtu':'" + $('#txtthoigianthicongtu').val() + "',";
       DataJson += "'thoigianthicongden':'" + $('#txtthoigianthicongden').val() + "',";
       DataJson += "'hotengiamdocduan':'" + $('#txthotengiamdocduan').val() + "',";

       DataJson += "'nguoilapkpi':'" + $('#txtnguoilapkpi').val() + "',";
       DataJson += "'nguoilapkpi_email':'" + $('#txtnguoilapkpi_email').val() + "',";
       DataJson += "'nguoilapkpi_ngay':'" + $('#txtnguoilapkpi_ngay').val() + "',";

       DataJson += "'photongxemxetkpi':'" + $('#txtphotongxemxetkpi').val() + "',";
       DataJson += "'photongxemxetkpi_email':'" + $('#txtphotongxemxetkpi_email').val() + "',";
       DataJson += "'photongxemxetkpi_ngay':'" + $('#txtphotongxemxetkpi_ngay').val() + "',";

       DataJson += "'tonggiamdocxemxetkpi':'" + $('#txttonggiamdocxemxetkpi').val() + "',";
       DataJson += "'tonggiamdocxemxetkpi_email':'" + $('#txttonggiamdocxemxetkpi_email').val() + "',";
       DataJson += "'tonggiamdocxemxetkpi_ngay':'" + $('#txttonggiamdocxemxetkpi_ngay').val() + "',";

       DataJson += "'bankiemsoat_email':''";

       DataJson += "}, 'data2':[";

       $('#boxContent table tbody tr').each(function (index, item) {

           debugger;
           var b = $('#boxContent table tbody tr').length - 1;

           var makpiphongban_chitiet = encodeURIComponent($(item).attr('makpiphongban_chitiet'));
           var makpiphongban = encodeURIComponent($(item).attr('makpiphongban'));
           var stt = $(item).find('td.col1').text();

           var congty = $(item).attr('congty');
           var sttcon = $(item).attr('sttcon');
           var sttcha = $(item).attr('sttcha');


           var muctieu = ""; var trongso = "0%"; var ketqua = "0%";
           if (stt == "A" || stt == "B" || stt == "C" || stt == "D" || stt == "E" || stt == "F" || stt == "" || stt == null) {
               muctieu = $(item).find('td.col2').text();
               trongso = $(item).find('td.col3 input').val();
               ketqua = $(item).find('td.col12 input').val();
               thuoccap = stt;
           }
           else {
               muctieu = $(item).find('td.col2 textarea').val();
               trongso = $(item).find('td.col3 textarea').val();
               ketqua = $(item).find('td.col12 textarea').val();
           }

           if (congty == undefined) congty = "0";
           if (sttcon == undefined) sttcon = "0";
           if (congty == undefined) congty = "0";


           muctieu = muctieu.replace(/'/g, "daunhaydon").replace(/"/g, '').replace(/&/g, 'daukytuva');

           var tieuchidanhgia = $(item).find('td.col4 textarea').val(); if (tieuchidanhgia == undefined) tieuchidanhgia = "";
           else tieuchidanhgia = tieuchidanhgia.replace(/'/g, "daunhaydon").replace(/"/g, '').replace(/&/g, 'daukytuva');

           var cachtinh = $(item).find('td.col5 textarea').val(); if (cachtinh == undefined) cachtinh = "";
           else cachtinh = cachtinh.replace(/'/g, "daunhaydon").replace(/"/g, '').replace(/&/g, 'daukytuva');

           var ngayghinhanketqua = $(item).find('td.col6 textarea').val(); if (ngayghinhanketqua == undefined) ngayghinhanketqua = "";
           else ngayghinhanketqua = ngayghinhanketqua.replace(/'/g, "daunhaydon").replace(/"/g, '').replace(/&/g, 'daukytuva');

           var nguonchungminh = $(item).find('td.col7 textarea').val(); if (nguonchungminh == undefined) nguonchungminh = "";
           else nguonchungminh = nguonchungminh.replace(/'/g, "daunhaydon").replace(/"/g, '').replace(/&/g, 'daukytuva');

           var donvitinh = $(item).find('td.col8 textarea').val(); if (donvitinh == undefined) donvitinh = "";
           else donvitinh = donvitinh.replace(/'/g, "daunhaydon").replace(/"/g, '').replace(/&/g, 'daukytuva');

           var kehoach = $(item).find('td.col9 textarea').val(); if (kehoach == undefined) kehoach = "";
           else kehoach = kehoach.replace(/'/g, "daunhaydon").replace(/"/g, '').replace(/&/g, 'daukytuva');

           var thuchien = $(item).find('td.col10 textarea').val(); if (thuchien == undefined) thuchien = "";
           else thuchien = thuchien.replace(/'/g, "daunhaydon").replace(/"/g, '').replace(/&/g, 'daukytuva');

           var tilehoanthanh = $(item).find('td.col11 textarea').val(); if (tilehoanthanh == undefined) tilehoanthanh = "";
           else tilehoanthanh = tilehoanthanh.replace(/'/g, "daunhaydon").replace(/"/g, '').replace(/&/g, 'daukytuva');

           var ghichu = $(item).find('td.col13 textarea').val(); if (ghichu == undefined) ghichu = "";
           else ghichu = ghichu.replace(/'/g, "daunhaydon").replace(/"/g, '').replace(/&/g, 'daukytuva');


           DataJson += "{";
           DataJson += "'makpiphongban_chitiet':'" + makpiphongban_chitiet + "',";
           DataJson += "'makpiphongban':'" + makpiphongban + "',";

           DataJson += "'congty':'" + congty + "',";
           DataJson += "'sttcon':'" + sttcon + "',";
           DataJson += "'sttcha':'" + sttcha + "',";

           DataJson += "'stt':'" + stt + "',";
           DataJson += "'muctieu':'" + muctieu + "',";

           DataJson += "'tieuchidanhgia':'" + tieuchidanhgia + "',";
           DataJson += "'cachtinh':'" + cachtinh + "',";
           DataJson += "'ngayghinhanketqua':'" + ngayghinhanketqua + "',";
           DataJson += "'nguonchungminh':'" + nguonchungminh + "',";
           DataJson += "'donvitinh':'" + donvitinh + "',";
           DataJson += "'kehoach':'" + kehoach + "',";
           DataJson += "'thuchien':'" + thuchien + "',";
           DataJson += "'tilehoanthanh':'" + tilehoanthanh + "',";
           DataJson += "'ghichu':'" + ghichu + "',";
           DataJson += "'ketqua':'" + ketqua + "',";
           DataJson += "'thuoccap':'" + thuoccap + "',";
           DataJson += "'trongso':'" + trongso + "'";
           DataJson += "}";

           var a = index;
           if (a != b)
               DataJson += ",";
       });
       DataJson += "]}";

       $.ajax({
           type: 'POST',
           url: '/KpiCompany/Save_Construction_guimail',
           datatype: "JSON",
           data: "DataJson=" + DataJson,
           cache: false,
       })
       .done(function (result) {
           debugger;
           var tb = JSON.stringify(result.success);
           var makpiphongban = JSON.stringify(result.makpiphongban);
           if (tb == "true") {
               var dialogSuccess = bootbox.dialog({
                   message: "<i class='fa fa-check text-success'></i><span class='text-success'>Lưu và gửi dữ liệu thành công.</span>",
                   closeButton: false,
                   onEscape: function () {
                   }
               });
               setTimeout(function () {
                   $('#txtmakpiphongban').val(makpiphongban);
                   $('#txtnguoilapkpi_dagui').val('1');
                   dialogSuccess.modal('hide');
                   history.back();
               }, 2000);
           }
           else if (tb == "1") {
               var dialogSuccess = bootbox.dialog({
                   message: "<i class='fa fa-check text-success'></i><span class='text-success'>Đã xảy ra lỗi trong quá trình xử lý.</span>",
                   closeButton: false,
                   onEscape: function () {
                   }
               });
               setTimeout(function () {
                   $('#txtmakpiphongban').val(makpiphongban);
                   dialogSuccess.modal('hide');
                   history.back();
               }, 2000);
           }
           else {
               var dialogSuccess = bootbox.dialog({
                   message: "<i class='fa fa-check text-success'></i><span class='text-success'>Lưu và gửi dữ liệu không thành công</span>",
                   closeButton: false,
                   onEscape: function () {
                   }
               });
               setTimeout(function () {
                   $('#txtmakpiphongban').val(0);
                   $('#txtnguoilapkpi_dagui').val('0');
                   dialogSuccess.modal('hide');
               }, 2000);
           }
       })
       .fail(function (result) {
           alert("FAILED: " + JSON.stringify(result));
       });
   })

    function currencyFormatDE(num) {
        return (num + "").replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
    }

    function calTotal() {
        debugger;
        var total = 0;
        var sub = 0;
        $('#boxContent table tbody tr').each(function (index, itemitem) {
            debugger;
            //var kpitong = $('#boxContent #tableContent tbody tr[kpicha="' + 1 + '"]').length;
            //var kpitong1111 = $('#boxContent #tableContent tbody tr[kpicha="' + 1 + '"]');
            //var bbbb = $(itemitem).find('tr[kpicha="' + 1 + '"]').length;
            var kpicha = $(itemitem).attr('kpicha');
            //var bbbbbbbb = $(itemitem).find('td.col3 input').val();
            //var aaa = kpitong1111.find('td.col3 input').val();
            sub = $(itemitem).find('td.col3 input').val();
            if (kpicha == 1) {
                sub = $(itemitem).find('td.col3 input').val().replace("%", "").replace("%", "").replace(" ", "");
                sub = Number(sub);
                if (isNaN(sub) == false)
                    total = total + sub;
            }
        });
        
        var currentRow2 = $('#boxContent table tbody tr:last').closest('.rows-box');
        currentRow2.find('.col3 input').val(total + "%");
    }

    $('#tableContent').on('keyup', 'input', function (e) {
        debugger;
        var currentRow = $(this).closest('.rows-box');
        var soluong = $(this).val().replace('%', '');
        if (isNaN(soluong) == false)
            currentRow.find('.col12 input').val(currencyFormatDE(soluong+"%")) ;
        calTotal();
    });

    $('#boxContent').on('click', '.button-add', function () {
        debugger;
        var stt = $("#tableContent > tbody > tr").length + 1;
        var target = $(this).closest('tr').attr('group');
        
        var destination = $(this).closest('tr');
        
        var thutuinsert = destination.length;
        var row = $(this).closest('tr').clone();
        $(row).insertAfter($(destination));
        
        $(row).find('td.col1').text(thutuinsert);
        $(row).find('td.col2 textarea').val('');
       // $(row).find('td.col2 textarea').removeAttr('readonly');
        $(row).find('td.col3 textarea').val('');
        $(row).find('td.col4 textarea').val('');
        $(row).find('td.col5 textarea').val('');
        $(row).find('td.col6 textarea').val('');
        $(row).find('td.col7 textarea').val('');
        $(row).find('td.col8 textarea').val('');
        $(row).find('td.col9 textarea').val('');
        $(row).find('td.col10 textarea').val('');
        $(row).find('td.col11 textarea').val('');
        $(row).find('td.col12 textarea').val('');
        $(row).find('td.col13 textarea').val('');
        $(row).find('tr codeid').val(0);
        $(row).attr('codeid', '0');
        $(row).attr('congty', '0');
        $(row).attr('sttcha', '1');
        $(row).attr('makpiphongban_chitiet', '0');
        $(row).find('td.col1').attr('style', 'text-align:center');
        var i = 1;
        $('#boxContent table tbody tr[group="' + target + '"]').each(function (index, item) {
            if (i > 1)
                $(item).find('td.col1').text(i);
            i = i + 1;
        });


    });

    $('#boxContent').on('click', '.button-del', function () {
        debugger;
        var target = $(this).closest('tr').attr('group');
        if ($("#tableContent > tbody > tr[group='" + target + "'] ").length > 2) {
            $(this).closest('tr').remove();
            var i = 1;
            $('#boxContent table tbody tr[group="' + target + '"]').each(function (index, item) {
                if (i > 1)
                    $(item).find('td.col1').text(i);
                i = i + 1;
            });
        }
    });

    function renderDate() {
        var day = new Date();
        var dd = day.getDate();
        var mm = day.getMonth() + 1;
        var yyyy = day.getFullYear();
        if (dd < 10) {
            dd = '0' + dd;
        }
        if (mm < 10) {
            mm = '0' + mm;
        }
        var today = dd + '/' + mm + '/' + yyyy;
        var html = '';
        //debugger;
        html += '<tr>';
        //html += '<th rowspan="4" colspan="2">Logo</th>'

        html += '<th rowspan="3" colspan="2" class="boxEdit" style="font-size: 16pt;color:#f3332e;padding-top: 35px">NĂM KPI<textarea style="width:100%; font-size: 29pt; color:#8e2bf1; border: 0px; text-align: center; resize:none;" rows="1" placeholder="" id="txtnam" name="nam">' + day.getFullYear() + '</textarea></th>'

        html += '<th colspan="11" style="font-size: 18pt;background-color: #4cffff;color: #8e2bf1;">KPI CẤP CÔNG TRƯỜNG - NĂM ' + day.getFullYear() + '</th>'
        html += '<th rowspan="4" colspan="14">Chức năng</th>'
        html += '</tr>'

        html += '<tr class="boxEdit" style="box-shadow: none;">'
        html += '<th colspan="6" style="text-align: left">'
        html += '<div class="row">'
        html += '<div class="col-md-1" style="min-width: 150px; padding-left:10px;">Tên dự Án:<label style="color:red;height:10px;">*</label>:</div>'
        html += '<div class="col-md-8" style="padding-left:10px;"><select id="filter02" style="width:100%;padding-left: 2px;border: 1px solid #aaa;  border-radius: 3px;background-color: #fff;height: 26px;" class="chosen-select-loaikehoach" name="maphongban">@Html.Raw(ViewBag.sbphongban)</select></div>'
        html += '</div>'

        html += '<div class="row">'
        html += '<div class="col-md-1" style="min-width: 150px; padding-left:10px;">Địa điểm<label style="color:red;height:10px;">*</label>:</div>'
        html += '<div class="col-md-8" style="padding-left:10px;"><input type="text" style="width: 100%;" autocomplete="off" placeholder="Địa chỉ của dự án" id="txtbophansoanthao" name="bophansoanthao" value="" /></div>'
        html += '</div>'

        html += '<div class="row">'
        html += '<div class="col-md-1" style="min-width: 150px; padding-left:10px;">Thời gian thi công<label style="color:red;height:10px;">*</label>:</div>'
        html += '<div class="col-md-4" style="padding-left:10px;"><input type="text" style="width: 100%;text-align: center" autocomplete="off" placeholder="Từ ngày" id="txtthoigianthicongtu" name="thoigianthicongtu" value="' + today + '" /></div>'
        html += '<div class="col-md-4" style="padding-left:10px;"><input type="text" style="width: 100%;text-align: center" autocomplete="off" placeholder="Đến ngày" id="txtthoigianthicongden" name="thoigianthicongden" value="' + today + '" /></div>'
        html += '</div>'
        html += '</th>'

        html += '<th colspan="5" style="text-align: left">'
        html += '<div class="row">'
        html += '<div class="col-md-1" style="min-width: 150px; padding-left:10px;">Chỉ huy trưởng<label style="color:red;height:10px;">*</label>:</div>'
        html += '<div class="col-md-7" ><input type="text" style="width: 100%;" autocomplete="off" placeholder="Họ tên chỉ huy trưởng" id="txtmanhanvien" name="manhanvien" value="@Model.hoten" /></div>'
        html += '</div>'
        html += '<div class="row">'
        html += '<div class="col-md-1" style="min-width: 150px; padding-left:10px;">Giám đốc dự án<label style="color:red;height:10px;">*</label>:</div>'
        html += '<div class="col-md-7" ><input type="text" style="width: 100%;" autocomplete="off" placeholder="Họ tên giám đốc dự án" id="txthotengiamdocduan" name="hotengiamdocduan" value="@Model.captrentructiep" /></div>'
        html += '</div>'
        
        html += '</th>'
        html += '</tr>'


        html += '<tr>'
        html += '<th colspan="2" style="text-align: left">Ngày ban hành'
        html += '<th colspan="2" class="ovh col2 boxEdit"><input type="text" style="width:100%; text-align: center" autocomplete="off" placeholder="Ngày ban hành" id="txtngaybanhanh" name="ngaybanhanh" value="' + today + '" /></th>'

        html += '<th colspan="2" style="text-align: left">Ngày cập nhật</th>'
        html += '<th colspan="2" class="ovh col2 boxEdit"><input type="text" style="width:100%;text-align: center"  autocomplete="off" placeholder="Ngày cập nhật" id="txtngaycapnhat" name="ngaycapnhat" value="' + today + '" /></th>'
        html += '<th colspan="3">Lần cập nhật: 00/01</th>'
        html += '</tr>'

        html += '<tr>';
        html += '<th class="ovh col1">Stt</th>'
        html += '<th class="ovh col2">Mục tiêu</th>'
        html += '<th class="ovh col3">Trọng số</th>'
        html += '<th class="ovh col4">Tiêu chí đánh giá (KPIs)</th>'
        html += '<th class="ovh col5">Cách tính</th>'
        html += '<th class="ovh col6">Thời điểm ghi nhận kết quả</th>'
        html += '<th class="ovh col7">Nguồn chứng minh</th>'
        html += '<th class="ovh col8">Đơn vị tính</th>'
        html += '<th class="ovh col9">KPIs kế hoạch</th>'
        html += '<th class="ovh col10">KPIs thực hiện</th>'
        html += '<th class="ovh col11">Tỉ lệ % hoàn thành KPIs</th>'
        html += '<th class="ovh col12">Kết quả</th>'
        html += '<th class="ovh col13">Ghi chú</th>'

        html += '</tr>';

        $('#head-date').html(html);
    }

    function Thongbao(num) {
        var dialogSuccess = bootbox.dialog({
            message: "<i class='fa fa-check text-success'></i><span class='text-success'>" + num + "</span>",
            closeButton: false,
            onEscape: function () {
            }
        });
        setTimeout(function () {
            dialogSuccess.modal('hide');
        }, 1000);
    }

</script>

